name: Bootstrap Rust MSYS2
on:
  workflow_dispatch:

jobs:
  cross_rust:
    runs-on: windows-latest

    steps:
      - run: git config --global core.autocrlf input
      - uses: actions/checkout@v5
      - id: msys2
        uses: msys2/setup-msys2@v2
        with:
          release: true
          update: true
          msystem: MSYS
          install: >-
            base-devel
            gcc
            llvm
            python
            python-pip
            libgit2-devel
            libssh2-devel
            openssl-devel
            pcre2-devel
            pkgconf
            libsqlite-devel
            liblzma-devel
            libzstd-devel
            zlib-devel
            libcurl-devel
            mingw-w64-x86_64-python
            mingw-w64-x86_64-llvm
            mingw-w64-x86_64-clang
      - name: build
        run: |
          mkdir bin
          gcc -o bin/llvm-config.exe llvm-config-wrapper.c
          gcc -o bin/gcc.exe wrapper.c
          for b in g++ ar ranlib x86_64-pc-cygwin-gcc curl-config; do
            ln bin/gcc.exe bin/${b}.exe
          done
          pip install --user --break-system-packages tomli
          RUST_URL="$(python -c "import tomli; from urllib.request import urlopen; x = tomli.load(urlopen('https://static.rust-lang.org/dist/channel-rust-nightly.toml')); a = [y for y in x['artifacts']['source-code']['target']['*'] if y['url'].endswith('.xz')]; print(a[0]['url'])")"
          echo "$RUST_URL" | tee rust-url.txt
          curl -LO "$RUST_URL"
          MSYS=winsymlinks:sys tar -Jxf rustc-nightly-src.tar.xz
          cd rustc-nightly-src
          MSYS2_ROOT="$(cygpath -m /)" WORKSPACE="$(cygpath -ma "../bin")" envsubst < ../bootstrap.toml | sed -e 's/gz/xz/' > bootstrap.toml
          export PATH="$(cygpath -ua ../bin):/mingw64/bin:$PATH"
          unset PKG_CONFIG_PATH
          PKG_CONFIG_SYSROOT_DIR="$(cygpath -w /)" \
          PKG_CONFIG="$(cygpath -w /usr/bin/pkgconf.exe)" \
          LIBGIT2_NO_VENDOR=1 \
          OPENSSL_DIR="$(cygpath -w /usr)" \
          OPENSSL_LIB_DIR="$(cygpath -w /usr/lib)" \
          OPENSSL_STATIC=0 \
          LIBSQLITE3_SYS_USE_PKG_CONFIG=1 \
          DESTDIR="$(cygpath -w "$PWD/build-Cygwin/dest-rust")" \
          python x.py dist
        shell: msys2 '{0}'
      - uses: actions/upload-artifact@v4
        with:
          name: rust-prefix
          path: |
            rust-url.txt
            rustc-nightly-src/build-Cygwin/dist/*

  upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: cross_rust
    if: ${{ github.ref != 'refs/heads/main' }}

    steps:
      - uses: actions/download-artifact@v6
        with:
          name: rust-dist
          path: rust-dist
      - name: release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          gh -R '${{ github.repository }}' release create rust-1.89.0-msys2 --target '${{ github.sha }}' --title rust-1.89.0-msys2 --notes "" rust-dist/*

